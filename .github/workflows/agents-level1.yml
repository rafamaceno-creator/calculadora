name: Agents ‚Äì Improvement Plan (Level 1)

on:
  issues:
    types: [labeled]

jobs:
  run-agents:
    if: github.event.label.name == 'improve'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate AGENTS_RULES.md exists
        run: |
          if [ ! -f AGENTS_RULES.md ]; then
            echo "‚ùå AGENTS_RULES.md not found in repo root"
            exit 1
          fi

      - name: Read AGENTS_RULES.md
        id: rules
        run: |
          echo "rules<<EOF" >> $GITHUB_OUTPUT
          cat AGENTS_RULES.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build prompt
        id: build-prompt
        run: |
          cat <<'EOF' > prompt.txt
Voc√™ √© um sistema de orquestra√ß√£o multi-agente para melhorias incrementais de produto.

========================
REGRAS OBRIGAT√ìRIAS (FONTE DE VERDADE)
========================
${{ steps.rules.outputs.rules }}

========================
CONTEXTO DA ISSUE
========================
T√≠tulo:
${{ github.event.issue.title }}

Descri√ß√£o:
${{ github.event.issue.body }}

========================
INSTRU√á√ïES GERAIS
========================
- Respeite TODAS as regras acima sem exce√ß√£o.
- √â PROIBIDO alterar f√≥rmulas, c√°lculos, custos, taxas, comiss√µes ou regras financeiras.
- Gere apenas melhorias incrementais, seguras e focadas em utilidade.
- Divida sua resposta obrigatoriamente nos pap√©is:
  1) üß† UX
  2) üõ†Ô∏è Front-end
  3) üß™ QA
  4) üöÄ Release Captain

REGRAS DO RELEASE CAPTAIN:
- Deve gerar UM √öNICO PROMPT FINAL.
- O prompt deve estar PRONTO PARA COPIAR E COLAR NO CODEX.
- N√£o gere c√≥digo diretamente.
- N√£o invente arquivos; instrua o Codex a localizar os pontos corretos.
- Mantenha PR pequeno e focado.
- Confirme explicitamente que c√°lculos n√£o foram alterados.

Formato obrigat√≥rio da resposta:

ü§ñ Agents ‚Äì Improvement Plan (Level 1)

üß† UX
(descrever problemas, impacto, solu√ß√£o m√≠nima)

üõ†Ô∏è Front-end
(descrever escopo t√©cnico, arquivos a tocar, sem c√≥digo)

üß™ QA
(checklist de testes + n√£o-regress√£o)

üöÄ Release Captain (PROMPT PARA CODEX)
(aqui deve vir SOMENTE o prompt final)

Responda em portugu√™s.
EOF

      - name: Send prompt to OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4.1-mini\",
              \"temperature\": 0.2,
              \"messages\": [
                {\"role\": \"system\", \"content\": \"$(sed 's/\"/\\\\\"/g' prompt.txt)\"}
              ]
            }")

          echo "$RESPONSE" > response.json

      - name: Extract model response
        id: extract
        run: |
          CONTENT=$(jq -r '.choices[0].message.content' response.json)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post comment on issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(cat <<EOF
## ü§ñ Agents ‚Äì Improvement Plan (Level 1)

${{ steps.extract.outputs.content }}
EOF
)
          curl -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "$(jq -n --arg body "$BODY" '{body: $body}')"
