name: Agents â€“ Improvement Plan (Level 1)

on:
  issues:
    types: [labeled]

jobs:
  run-agents:
    if: github.event.label.name == 'improve'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build agents plan
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        run: |
          node << 'EOF'
          import fetch from "node-fetch";

          const contextBase = `
          Repo: ${process.env.REPO_URL}

          Objetivo:
          - MAIS ÃšTIL
          - MAIS SIMPLES
          - MAIS INTUITIVO
          Beleza Ã© secundÃ¡ria.

          Regras:
          - NÃƒO alterar fÃ³rmulas, custos, comissÃµes, taxas ou cÃ¡lculos.
          - RevisÃ£o de cÃ¡lculo = apenas AUDIT (issue separada).
          - Fluxo/wizard pode mudar SOMENTE para simplificar.
          - PR pequeno, mudanÃ§as mÃ­nimas.
          - Ler e seguir AGENTS_RULES.md obrigatoriamente.
          `;

          const issue = `
          TÃTULO:
          ${process.env.ISSUE_TITLE}

          DESCRIÃ‡ÃƒO:
          ${process.env.ISSUE_BODY}
          `;

          async function callLLM(role, task) {
            const res = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "gpt-4.1-mini",
                temperature: 0.2,
                messages: [
                  { role: "system", content: `VocÃª Ã© o ${role}.` },
                  { role: "user", content: contextBase + issue + task }
                ]
              })
            });

            const data = await res.json();
            return data.choices[0].message.content;
          }

          const ux = await callLLM(
            "Agente UX",
            "Liste os principais problemas de usabilidade e soluÃ§Ãµes mÃ­nimas focadas em utilidade."
          );

          const fe = await callLLM(
            "Agente Front-end",
            "Transforme os pontos do UX em plano tÃ©cnico de implementaÃ§Ã£o mÃ­nima, sem mexer em cÃ¡lculos."
          );

          const qa = await callLLM(
            "Agente QA",
            "Crie checklist de testes e cenÃ¡rios de nÃ£o-regressÃ£o de cÃ¡lculo."
          );

          const release = await callLLM(
            "Release Captain",
            `
            Consolide tudo e gere:
            1) Escopo fechado do PR #1
            2) Prompt FINAL para o Codex gerar o PR
            `
          );

          const comment = `
          ## ðŸ¤– Agents â€“ Improvement Plan

          ### ðŸ§  UX
          ${ux}

          ---
          ### ðŸ› ï¸ Front-end
          ${fe}

          ---
          ### ðŸ§ª QA
          ${qa}

          ---
          ### ðŸš€ Release Captain (PROMPT DO CODEX)
          ${release}
          `;

          console.log(comment);
          EOF

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: process.env.NODE_OUTPUT
            })
