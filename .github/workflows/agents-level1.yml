name: Agents ‚Äì Improvement Plan (Level 1)

on:
  issues:
    types: [labeled]

jobs:
  run-agents:
    if: github.event.label.name == 'improve'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run agents and comment plan
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const apiKey = process.env.OPENAI_API_KEY;
            if (!apiKey) {
              core.setFailed("Missing OPENAI_API_KEY secret. Add it in Settings ‚Üí Secrets and variables ‚Üí Actions.");
              return;
            }

            const repoUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}`;
            const issueTitle = context.payload.issue.title || "";
            const issueBody = context.payload.issue.body || "";

            const contextBase = `
            Repo: ${repoUrl}

            Objetivo (ordem):
            1) MAIS √öTIL
            2) MAIS SIMPLES de mexer/manter/alimentar
            3) MAIS INTUITIVO
            Beleza √© secund√°ria.

            Regras obrigat√≥rias:
            - Leia e siga AGENTS_RULES.md (raiz do repo) antes de sugerir qualquer mudan√ßa.
            - N√ÉO alterar f√≥rmulas/custos/comiss√µes/taxas/regras de c√°lculo.
            - Se suspeitar de bug de c√°lculo: marcar como "AUDIT" e recomendar Issue separada (n√£o corrigir neste PR).
            - Fluxo/wizard pode mudar SOMENTE para simplificar e reduzir confus√£o.
            - PR pequeno e mudan√ßas m√≠nimas.
            `;

            const issueText = `
            T√çTULO:
            ${issueTitle}

            DESCRI√á√ÉO:
            ${issueBody}
            `;

            async function callOpenAI(roleName, task) {
              const body = {
                model: "gpt-4.1-mini",
                temperature: 0.2,
                messages: [
                  { role: "system", content: `Voc√™ √© o ${roleName}. Responda em PT-BR, direto e pr√°tico.` },
                  { role: "user", content: contextBase + "\n\n" + issueText + "\n\n" + task }
                ]
              };

              const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${apiKey}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
              });

              const data = await res.json();
              if (!res.ok) {
                throw new Error(`OpenAI API error: ${res.status} ${JSON.stringify(data)}`);
              }
              return data.choices?.[0]?.message?.content?.trim() || "(sem resposta)";
            }

            const uxTask = `
            Voc√™ √© o Agente UX (mobile-first).
            1) Liste os 7 maiores problemas de usabilidade/clareza no Step 0 do wizard (e arredores imediatos).
            2) Para cada problema, proponha SOLU√á√ÉO M√çNIMA (menor mudan√ßa poss√≠vel) que aumenta utilidade e reduz confus√£o.
            3) Para cada item: Impacto (alto/m√©dio/baixo), Esfor√ßo (P/M/G), Risco.
            4) N√£o sugerir mudan√ßas de c√°lculo. Se notar incoer√™ncia, sinalize como "AUDIT" e pare nesse ponto.
            Formato: P0/P1/P2.
            `;

            const feTask = `
            Voc√™ √© o Agente Front-end Engineer.
            Use o resultado do UX para montar um plano de 1 PR pequeno:
            - Lista de mudan√ßas por arquivo (CSS/HTML/JS).
            - Abordagem m√≠nima e segura (sem refatora√ß√£o grande).
            - Ajustes para hover/focus/pressed/selected, √°rea clic√°vel, cursor, acessibilidade teclado.
            - N√£o alterar f√≥rmulas/custos/comiss√µes.
            Formato: Escopo PR #1 + Lista por arquivo + Notas t√©cnicas.
            `;

            const qaTask = `
            Voc√™ √© o Agente QA.
            - Crie checklist de testes (mobile e desktop).
            - Crie 5 cen√°rios de n√£o-regress√£o (confirmar que c√°lculos n√£o mudaram; pode ser "resultado id√™ntico antes/depois").
            - Liste riscos comuns (estado do wizard, sele√ß√£o, voltar/avan√ßar, responsivo).
            Formato em checklist.
            `;

            const releaseTask = `
            Voc√™ √© o Release Captain.
            Consolide UX+FE+QA e entregue:
            1) Escopo fechado do PR #1 (somente o que cabe em PR pequeno)
            2) PROMPT √öNICO pro Codex (ctrl+c/ctrl+v) com:
               - objetivo
               - regras (N√ÉO mexer em c√°lculos; ler AGENTS_RULES.md)
               - lista detalhada do que alterar por arquivo
               - checklist de teste
               - pedir retorno em diff + resumo + como testar
            `;

            const ux = await callOpenAI("Agente UX", uxTask);
            const fe = await callOpenAI("Agente Front-end", `INSUMO UX:\n${ux}\n\n${feTask}`);
            const qa = await callOpenAI("Agente QA", `PLANO FE:\n${fe}\n\n${qaTask}`);
            const release = await callOpenAI("Release Captain", `UX:\n${ux}\n\nFE:\n${fe}\n\nQA:\n${qa}\n\n${releaseTask}`);

            const comment = [
              "## ü§ñ Agents ‚Äì Improvement Plan (Level 1)",
              "",
              "### üß† UX",
              ux,
              "",
              "---",
              "### üõ†Ô∏è Front-end",
              fe,
              "",
              "---",
              "### üß™ QA",
              qa,
              "",
              "---",
              "### üöÄ Release Captain (PROMPT DO CODEX)",
              release
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: comment
            });
